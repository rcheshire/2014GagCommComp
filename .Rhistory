} else{dv.nfish[i]=0.0000001;dv.unw.tab[i,]=0}
}
dv.norm.unw=dv.unw.tab/dv.nfish
############# STATE-SPECIFIC COMPS
#north carolina handline
nc.hl.unw=summaryBy(num~year+tl3cm,data=tip.hl[tip.hl$state=='NC',],FUN=sum)
nc.hl.unw.tab=xtabs(num.sum~year+tl3cm,data=nc.hl.unw)
nc.hl.unw.tab=as.data.frame.matrix(nc.hl.unw.tab)
nc.hl.nfish=rowSums(nc.hl.unw.tab)
for(i in 1:length(nc.hl.nfish)){
if (nc.hl.nfish[i]>st.cutoff){nc.hl.nfish[i]=nc.hl.nfish[i]
} else{nc.hl.nfish[i]=0;nc.hl.unw.tab[i,]=0}
}
nc.hl.norm.unw=nc.hl.unw.tab/(nc.hl.nfish+0.00000001)
nc.hl.w=nc.hl.norm.unw*hl.state.land[,2]
#north carolina diving
nc.dv.unw=summaryBy(num~year+tl3cm,data=tip.dv[tip.dv$state=='NC',],FUN=sum)
nc.dv.unw.tab=xtabs(num.sum~year+tl3cm,data=nc.dv.unw)
nc.dv.unw.tab=as.data.frame.matrix(nc.dv.unw.tab)
nc.dv.nfish=rowSums(nc.dv.unw.tab)
for(i in 1:length(nc.dv.nfish)){
if (nc.dv.nfish[i]>st.cutoff){nc.dv.nfish[i]=nc.dv.nfish[i]
} else{nc.dv.nfish[i]=0;nc.dv.unw.tab[i,]=0}
}
nc.dv.norm.unw=nc.dv.unw.tab/(nc.dv.nfish+0.00000001)
nc.dv.w=nc.dv.norm.unw*dv.state.land[,2]
#south carolina handline
sc.hl.unw=summaryBy(num~year+tl3cm,data=tip.hl[tip.hl$state=='SC',],FUN=sum)
sc.hl.unw.tab=xtabs(num.sum~year+tl3cm,data=sc.hl.unw)
sc.hl.unw.tab=as.data.frame.matrix(sc.hl.unw.tab)
sc.hl.nfish=rowSums(sc.hl.unw.tab)
for(i in 1:length(sc.hl.nfish)){
if (sc.hl.nfish[i]>st.cutoff){sc.hl.nfish[i]=sc.hl.nfish[i]
} else{sc.hl.nfish[i]=0;sc.hl.unw.tab[i,]=0}
}
sc.hl.norm.unw=sc.hl.unw.tab/(sc.hl.nfish+0.00000001)
sc.hl.w=sc.hl.norm.unw*hl.state.land[,3]
#south carolina diving
sc.dv.unw=summaryBy(num~year+tl3cm,data=tip.dv[tip.dv$state=='SC',],FUN=sum)
sc.dv.unw.tab=xtabs(num.sum~year+tl3cm,data=sc.dv.unw)
sc.dv.unw.tab=as.data.frame.matrix(sc.dv.unw.tab)
sc.dv.nfish=rowSums(sc.dv.unw.tab)
for(i in 1:length(sc.dv.nfish)){
if (sc.dv.nfish[i]>st.cutoff){sc.dv.nfish[i]=sc.dv.nfish[i]
} else{sc.dv.nfish[i]=0;sc.dv.unw.tab[i,]=0}
}
sc.dv.norm.unw=sc.dv.unw.tab/(sc.dv.nfish+0.00000001)
sc.dv.w=sc.dv.norm.unw*dv.state.land[,3]
#georgia + florida handline (no data after 2005)
gafl.hl.unw=summaryBy(num~year+tl3cm,data=tip.hl[tip.hl$state=='GAFL',],FUN=sum)
gafl.hl.unw.tab=xtabs(num.sum~year+tl3cm,data=gafl.hl.unw)
gafl.hl.unw.tab=as.data.frame.matrix(gafl.hl.unw.tab)
gafl.hl.nfish=rowSums(gafl.hl.unw.tab)
for(i in 1:length(gafl.hl.nfish)){
if (gafl.hl.nfish[i]>st.cutoff){gafl.hl.nfish[i]=gafl.hl.nfish[i]
} else{gafl.hl.nfish[i]=0;gafl.hl.unw.tab[i,]=0}
}
gafl.hl.norm.unw=gafl.hl.unw.tab/(gafl.hl.nfish+0.00000001)
gafl.hl.w=gafl.hl.norm.unw*hl.state.land[,4]
#georgia diving
gafl.dv.unw=summaryBy(num~year+tl3cm,data=tip.dv[tip.dv$state=='GAFL',],FUN=sum)
gafl.dv.unw.tab=xtabs(num.sum~year+tl3cm,data=gafl.dv.unw)
gafl.dv.unw.tab=as.data.frame.matrix(gafl.dv.unw.tab)
gafl.dv.nfish=rowSums(gafl.dv.unw.tab)
for(i in 1:length(gafl.dv.nfish)){
if (gafl.dv.nfish[i]>st.cutoff){gafl.dv.nfish[i]=gafl.dv.nfish[i]
} else{gafl.dv.nfish[i]=0;gafl.dv.unw.tab[i,]=0}
}
gafl.dv.norm.unw=gafl.dv.unw.tab/(gafl.dv.nfish+0.00000001)
gafl.dv.w=gafl.dv.norm.unw*dv.state.land[,4]
# #florida handline
# fl.hl.unw=summaryBy(num~year+tl3cm,data=tip.hl[tip.hl$state=='FL',],FUN=sum)
# fl.hl.unw.tab=xtabs(num.sum~year+tl3cm,data=fl.hl.unw)
# fl.hl.unw.tab=as.data.frame.matrix(fl.hl.unw.tab)
# fl.hl.nfish=rowSums(fl.hl.unw.tab)
# for(i in 1:length(fl.hl.nfish)){
#   if (fl.hl.nfish[i]>st.cutoff){fl.hl.nfish[i]=fl.hl.nfish[i]
#                          } else{fl.hl.nfish[i]=0;fl.hl.unw.tab[i,]=0}
#   }
# fl.hl.norm.unw=fl.hl.unw.tab/(fl.hl.nfish+0.0000001)
# fl.hl.w=fl.hl.norm.unw*hl.state.land[,5]
#
# #florida diving
# fl.dv.unw=summaryBy(num~year+tl3cm,data=tip.dv[tip.dv$state=='FL',],FUN=sum)
# fl.dv.unw.tab=xtabs(num.sum~year+tl3cm,data=fl.dv.unw)
# fl.dv.unw.tab=as.data.frame.matrix(fl.dv.unw.tab)
# fl.dv.nfish=rowSums(fl.dv.unw.tab)
# for(i in 1:length(fl.dv.nfish)){
#   if (fl.dv.nfish[i]>st.cutoff){fl.dv.nfish[i]=fl.dv.nfish[i]
#                          } else{fl.dv.nfish[i]=0;fl.dv.unw.tab[i,]=0}
#   }
# fl.dv.norm.unw=fl.dv.unw.tab/(fl.dv.nfish+0.00000001)
# fl.dv.w=fl.dv.norm.unw*dv.state.land[,5]
#combine state comps
#handline
hl.w=nc.hl.w+sc.hl.w+gafl.hl.w
hl.norm.w=hl.w/rowSums(hl.w+0.0000001)
hl.norm.w.trim=hl.norm.w[rowSums(hl.norm.w)>0,]
hl.norm.unw.trim=hl.norm.unw[rowSums(hl.norm.w)>0,]
#diving
dv.w=nc.dv.w+sc.dv.w+gafl.dv.w
dv.norm.w=dv.w/rowSums(dv.w+0.0000001)
dv.norm.w.trim=dv.norm.w[rowSums(dv.norm.w)>0,]
dv.norm.unw.trim=dv.norm.unw[rowSums(dv.norm.w)>0,]
#trim state comps to match combined comps for plotting
#handline
nc.hl.w.trim=nc.hl.w[rowSums(hl.norm.w)>0,]
sc.hl.w.trim=sc.hl.w[rowSums(hl.norm.w)>0,]
gafl.hl.w.trim=gafl.hl.w[rowSums(hl.norm.w)>0,]
#fl.hl.w.trim=fl.hl.w[rowSums(hl.norm.w)>0,]
#diving
nc.dv.w.trim=nc.dv.w[rowSums(dv.norm.w)>0,]
sc.dv.w.trim=sc.dv.w[rowSums(dv.norm.w)>0,]
gafl.dv.w.trim=gafl.dv.w[rowSums(dv.norm.w)>0,]
#fl.dv.w.trim=fl.dv.w[rowSums(dv.norm.w)>0,]
###############end of comp weighting
#create sample size tables
#handlinernames=as.numeric(row.names(hl.norm.unw))
hl.ss=cbind(nc.hl.nfish,sc.hl.nfish,gafl.hl.nfish)
hl.ss=as.data.frame.matrix(hl.ss)
hl.ss$total=rowSums(hl.ss)
colnames(hl.ss)=c('NC','SC','GAFL','Total')
dv.ss=cbind(nc.dv.nfish,sc.dv.nfish,gafl.dv.nfish)
dv.ss=as.data.frame.matrix(dv.ss)
dv.ss$total=rowSums(dv.ss)
colnames(dv.ss)=c('NC','SC','GAFL','Total')
#diving
table1=xtable(hl.ss,digits=0)
print(table1,type="html")
table1=xtable(dv.ss,digits=0)
print(table1,type="html")
table1=xtable(hl.norm.w.trim,digits=4)
print(table1,type="html")
table1=xtable(dv.norm.w.trim,digits=4)
print(table1,type="html")
year=as.numeric(rownames(hl.norm.w.trim))
for(i in 1:dim(hl.norm.w.trim)[1]){
plot(lenbins,hl.norm.w.trim[i,],type='n',ylim=c(0,max(hl.norm.w.trim)),ylab='',xlab='TL (cm)')
text(35,max(hl.norm.w.trim),paste(year[i],'Handline',sep='-'))
if(year[i]>=1992){abline(v=50.8)}
lines(lenbins,hl.norm.w.trim[i,],lwd=2)
lines(lenbins,hl.norm.unw.trim[i,],lty=3,lwd=2)
lines(lenbins,nc.hl.w.trim[i,],lty=3,lwd=2,col="green")
lines(lenbins,sc.hl.w.trim[i,],lty=3,lwd=2,col="blue")
lines(lenbins,gafl.hl.w.trim[i,],lty=3,lwd=2,col="orange")
#lines(lenbins,fl.hl.w.trim[i,],lty=3,lwd=2,col="red")
legend('topright',lty=c(1,3,3,3,3),lwd=c(2,2,2,2,2),col=c('black','black','green','blue','orange'),legend=c('weighted','unweighted','NC','SC','GAFL'))
}
year=as.numeric(rownames(dv.norm.w.trim))
for(i in 1:dim(dv.norm.w.trim)[1]){
plot(lenbins,dv.norm.w.trim[i,],type='n',ylim=c(0,max(dv.norm.w.trim)),ylab='',xlab='TL (cm)')
text(35,max(dv.norm.w.trim),paste(year[i],'Diving',sep='-'))
if(year[i]>=1992){abline(v=50.8)}
lines(lenbins,dv.norm.w.trim[i,],lwd=2)
lines(lenbins,dv.norm.unw.trim[i,],lty=3,lwd=2)
lines(lenbins,nc.dv.w.trim[i,],lty=3,lwd=2,col="green")
lines(lenbins,sc.dv.w.trim[i,],lty=3,lwd=2,col="blue")
lines(lenbins,gafl.dv.w.trim[i,],lty=3,lwd=2,col="orange")
#lines(lenbins,fl.dv.w.trim[i,],lty=3,lwd=2,col="red")
legend('topright',lty=c(1,3,3,3,3),lwd=c(2,2,2,2,2),col=c('black','black','green','blue','orange'),legend=c('weighted','unweighted','NC','SC','GAFL'))
}
age.dat=read.csv(file='W:/SEDAR/Updates2014/Gag/Comps/Commercial/gag_ages_rinput.csv',header=TRUE)
#remove unused cols
age.dat=age.dat[,c(-1,-2)]
names(age.dat)=c('gear','tlmm','age','month','year','state')
age.dat$tlcm=rnd(age.dat$tlmm/10)
#convert upper and lower pooled values to 29 and 122 cm
age.dat$tlcm[age.dat$tlcm<29]=29 #lower (3 records for dat, none for dv)
age.dat$tlcm[age.dat$tlcm>122]=122 #upper (3 records for dat, none for dv)
age.hl=age.dat[age.dat$gear%in%c('HL','TWL','LL'),]
age.dv=age.dat[age.dat$gear%in%c('DV'),]
#convert to 3cm bins from 29 to 122 cm #############trickery
lenbins=seq(29,122,by=3)
#handline
age.hl$tl3cm[age.hl$tlcm%in%lenbins]=age.hl$tlcm[age.hl$tlcm%in%lenbins]
temp.tl=age.hl$tlcm+1
age.hl$tl3cm[temp.tl%in%lenbins]=temp.tl[temp.tl%in%lenbins]
temp.tl=age.hl$tlcm-1
age.hl$tl3cm[temp.tl%in%lenbins]=temp.tl[temp.tl%in%lenbins]
#diving
#convert to 3cm bins from 29 to 122 cm #############trickery
lenbins=seq(29,122,by=3)
age.dv$tl3cm[age.dv$tlcm%in%lenbins]=age.dv$tlcm[age.dv$tlcm%in%lenbins]
temp.tl=age.dv$tlcm+1
age.dv$tl3cm[temp.tl%in%lenbins]=temp.tl[temp.tl%in%lenbins]
temp.tl=age.dv$tlcm-1
age.dv$tl3cm[temp.tl%in%lenbins]=temp.tl[temp.tl%in%lenbins]
############## handline #################
# add zeros for missing combinations of state and length bin
#handline
y=min(age.hl$year):max(age.hl$year)
z=seq(min(age.hl$tl3cm,na.rm=TRUE),max(age.hl$tl3cm,na.rm=TRUE),by=3)
a=expand.grid(y=y,z=z)
colnames(a)=c('year','tl3cm')
age.hl.all=merge(a,age.hl,by=c('year','tl3cm'),all=TRUE)
age.hl.all$num=1
age.hl.all$num[is.na(age.hl.all$age)==TRUE] = 0
#length comp of aged fish (so that lcomp of aged fish can be compared to lcomp)
hl.lcompaged=summaryBy(num~year+tl3cm,data=age.hl.all,FUN=sum)
hl.lcompaged.tab=xtabs(num.sum~year+tl3cm,data=hl.lcompaged)
hl.lcompaged.nfish=rowSums(hl.lcompaged.tab)+0.0000001
for(i in 1:length(hl.lcompaged.nfish)){
if (hl.lcompaged.nfish[i]>st.cutoff){hl.lcompaged.nfish[i]=hl.lcompaged.nfish[i]
} else{hl.lcompaged.nfish[i]=0.0000001;hl.lcompaged.tab[i,]=0}
}
hl.lcompaged.norm=hl.lcompaged.tab/hl.lcompaged.nfish
########## hl age comp
#create num column for each age bin
age.hl.num=summaryBy(age~year+age,data=age.hl,FUN=length)
age.hl.num$numage=age.hl.num$age.length
# add zeros for missing combinations of year and age
y=min(age.hl$year):max(age.hl$year)
z=seq(min(age.hl$age,na.rm=TRUE),max(age.hl$age,na.rm=TRUE),by=1)
a=expand.grid(y=y,z=z)
colnames(a)=c('year','age')
age.hl.age=merge(a,age.hl.num,by=c('year','age'),all=TRUE)
age.hl.age$numage[is.na(age.hl.age$numage)==TRUE] = 0
#nominal age comp of aged fish
age.hl.acomp=summaryBy(numage~year+age,data=age.hl.age,FUN=sum)
age.hl.acomp.tab=xtabs(numage.sum~year+age,data=age.hl.acomp)
hl.age.acomp.nfish=rowSums(age.hl.acomp.tab)+0.0000001
for(i in 1:length(hl.age.acomp.nfish)){
if (hl.age.acomp.nfish[i]>st.cutoff){hl.age.acomp.nfish[i]=hl.age.acomp.nfish[i]
} else{hl.age.acomp.nfish[i]=0.0000001;age.hl.acomp.tab[i,]=0}
}
hl.age.acomp.norm=age.hl.acomp.tab/hl.age.acomp.nfish
#match length bins of matrices of wgted len comp with length comp of ages
#transform weighted length comp matrix into dataframe
hl.wgt.rshp=melt(hl.norm.w)
yr=rep(rownames(hl.norm.w),dim(hl.norm.w)[2])
hl.wgt.rshp=cbind(yr,hl.wgt.rshp)
names(hl.wgt.rshp)=c('year','tl3cm','lcomp')
hl.wgt.rshp$tl3cm=as.numeric(as.character(hl.wgt.rshp$tl3cm))
hl.wgt.rshp$year=as.numeric(as.character(hl.wgt.rshp$year))
#transform lencomp of aged fish matrix into dataframe
hl.age.lcomp.rshp=melt(hl.lcompaged.norm,id=c("year"))
names(hl.age.lcomp.rshp)=c('year','tl3cm','lcompaged')
## check that length bins match
# min(hl.wgt.rshp$tl3cm)
# max(hl.wgt.rshp$tl3cm)
# min(hl.age.lcomp.rshp$tl3cm)
# max(hl.age.lcomp.rshp$tl3cm)
#begin weighting
#merge both datasets together before division
chih=merge(hl.wgt.rshp,hl.age.lcomp.rshp,by=c('year','tl3cm'),all=TRUE)
#divide wgted comp by len comp (aged) to derive Chih's Reweighting factor
chih$wgt=chih$lcomp/chih$lcompaged
##remove NAs and InF
chih$wgt[is.infinite(chih$wgt)] <- 0
chih$wgt[is.na(chih$wgt)==TRUE] = 0
#####no length comps for 1979-82 so, use nominal (wt=1)
chih$wgt[chih$year%in%c(1979,1980,1981,1982)]=1
#combine age and chih reweighting data by year and len bin
acomp.hl=merge(age.hl,chih,by=c('year','tl3cm'),all=TRUE)
acomp.hl$wgt[is.na(acomp.hl$wgt)==TRUE] = 0
#remove unneccessary columns
acomp.hl=acomp.hl[,c(1,2,5,11)]
##############################WEIGHTED Handline AGE COMP
acomp.hl.w=summaryBy(wgt~year+age,data=acomp.hl,FUN=sum)
acomp.hl.w.tab=xtabs(wgt.sum~year+age,data=acomp.hl.w)
acomp.hl.w.norm=acomp.hl.w.tab/rowSums(acomp.hl.w.tab)
##pool weighted and unweighted age comps (0-20+)
x=rowSums(acomp.hl.w.norm[,21:28])
y=cbind(acomp.hl.w.norm[,1:20],x)
colnames(y)=0:20
acomp.hl.w.norm=y
x=rowSums(hl.age.acomp.norm[,21:28])
y=cbind(hl.age.acomp.norm[,1:20],x)
colnames(y)=0:20
hl.age.acomp.norm=y
############## Diving Acomp #################
# add zeros for missing combinations of state and length bin
#handline
age.dv$state=as.character(age.dv$state)
age.dv$state[age.dv$state=="GA"]="GAFL"
age.dv$state[age.dv$state=="FL"]="GAFL"
y=min(age.dv$year):max(age.dv$year)
z=0:20
a=expand.grid(y=y,z=z)
colnames(a)=c('year','age')
age.dv.all=merge(a,age.dv,by=c('year','age'),all=TRUE)
age.dv.all$num=1
age.dv.all$num[is.na(age.dv.all$state)==TRUE] = 0
############################
###begin unweighted age comp - diving
dv.unw.a=summaryBy(num~year+age,data=age.dv.all,FUN=sum)
dv.unw.a.tab=xtabs(num.sum~year+age,data=dv.unw.a)
dv.nfish.a=rowSums(dv.unw.a.tab)+0.0000001
for(i in 1:length(dv.nfish.a)){
if (dv.nfish.a[i]>st.cutoff){dv.nfish.a[i]=dv.nfish.a[i]
} else{dv.nfish.a[i]=0.0000001;dv.unw.a.tab[i,]=0}
}
dv.norm.a.unw=dv.unw.a.tab/dv.nfish.a
############# STATE-SPECIFIC DIVING AGE COMPS
#north carolina diving
nc.dv.a.unw=summaryBy(num~year+age,data=age.dv.all[age.dv.all$state=='NC',],FUN=sum)
nc.dv.a.unw.all=merge(a,nc.dv.a.unw,by=c('year','age'),all=TRUE)
nc.dv.a.unw.all$num.sum[is.na(nc.dv.a.unw.all$num.sum)==TRUE] = 0
nc.dv.a.unw.tab=xtabs(num.sum~year+age,data=nc.dv.a.unw.all)
nc.dv.a.unw.tab=as.data.frame.matrix(nc.dv.a.unw.tab)
nc.dv.a.nfish=rowSums(nc.dv.a.unw.tab)
for(i in 1:length(nc.dv.a.nfish)){
if (nc.dv.a.nfish[i]>st.cutoff){nc.dv.a.nfish[i]=nc.dv.a.nfish[i]
} else{nc.dv.a.nfish[i]=0;nc.dv.a.unw.tab[i,]=0}
}
nc.dv.a.norm.unw=nc.dv.a.unw.tab/(nc.dv.a.nfish+0.00000001)
nc.dv.a.w=nc.dv.a.norm.unw
for(i in 1:dim(nc.dv.a.norm.unw)[1]){
nc.dv.a.w[i,]=nc.dv.a.norm.unw[i,]*dv.state.land[dv.state.land$YEAR==as.numeric(rownames(nc.dv.a.norm.unw))[i],2]
}
#south carolina diving
sc.dv.a.unw=summaryBy(num~year+age,data=age.dv.all[age.dv.all$state=='SC',],FUN=sum)
sc.dv.a.unw.all=merge(a,sc.dv.a.unw,by=c('year','age'),all=TRUE)
sc.dv.a.unw.all$num.sum[is.na(sc.dv.a.unw.all$num.sum)==TRUE] = 0
sc.dv.a.unw.tab=xtabs(num.sum~year+age,data=sc.dv.a.unw.all)
sc.dv.a.unw.tab=as.data.frame.matrix(sc.dv.a.unw.tab)
sc.dv.a.nfish=rowSums(sc.dv.a.unw.tab)
for(i in 1:length(sc.dv.a.nfish)){
if (sc.dv.a.nfish[i]>st.cutoff){sc.dv.a.nfish[i]=sc.dv.a.nfish[i]
} else{sc.dv.a.nfish[i]=0;sc.dv.a.unw.tab[i,]=0}
}
sc.dv.a.norm.unw=sc.dv.a.unw.tab/(sc.dv.a.nfish+0.00000001)
sc.dv.a.w=sc.dv.a.norm.unw
for(i in 1:dim(sc.dv.a.norm.unw)[1]){
sc.dv.a.w[i,]=sc.dv.a.norm.unw[i,]*dv.state.land[dv.state.land$YEAR==as.numeric(rownames(sc.dv.a.norm.unw))[i],3]
}
#Georgia-Florida diving
gafl.dv.a.unw=summaryBy(num~year+age,data=age.dv.all[age.dv.all$state=='GAFL',],FUN=sum)
gafl.dv.a.unw.all=merge(a,gafl.dv.a.unw,by=c('year','age'),all=TRUE)
gafl.dv.a.unw.all$num.sum[is.na(gafl.dv.a.unw.all$num.sum)==TRUE] = 0
gafl.dv.a.unw.tab=xtabs(num.sum~year+age,data=gafl.dv.a.unw.all)
gafl.dv.a.unw.tab=as.data.frame.matrix(gafl.dv.a.unw.tab)
gafl.dv.a.nfish=rowSums(gafl.dv.a.unw.tab)
for(i in 1:length(gafl.dv.a.nfish)){
if (gafl.dv.a.nfish[i]>st.cutoff){gafl.dv.a.nfish[i]=gafl.dv.a.nfish[i]
} else{gafl.dv.a.nfish[i]=0;gafl.dv.a.unw.tab[i,]=0}
}
gafl.dv.a.norm.unw=gafl.dv.a.unw.tab/(gafl.dv.a.nfish+0.00000001)
gafl.dv.a.w=gafl.dv.a.norm.unw
for(i in 1:dim(gafl.dv.a.norm.unw)[1]){
gafl.dv.a.w[i,]=gafl.dv.a.norm.unw[i,]*dv.state.land[dv.state.land$YEAR==as.numeric(rownames(gafl.dv.a.norm.unw))[i],4]
}
#combine diving state age comps
dv.w.acomp=nc.dv.a.w+sc.dv.a.w+gafl.dv.a.w
dv.acomp.norm.w=dv.w.acomp/rowSums(dv.w.acomp+0.0000001)
dv.acomp.norm.w.trim=dv.acomp.norm.w[rowSums(dv.acomp.norm.w)>0,]
dv.norm.a.unw.trim=dv.norm.a.unw[rowSums(dv.norm.a.unw)>0,]
age.hl$tmp=1
age.hl.ss=xtabs(tmp~year+state,data=age.hl)
age.hl.ss=as.data.frame.matrix(age.hl.ss)
age.hl.ss$GaFL=age.hl.ss[,2]+age.hl.ss[,3]
age.hl.ss=age.hl.ss[,c(-1,-2,-3)]
age.hl.ss$Total=rowSums(age.hl.ss)
table5=xtable(age.hl.ss,digits=0)
print(table5,type="html")
#truncate to years with minimun sample size
cull.hl.ages=30
acomp.hl.w.norm2=acomp.hl.w.norm[as.numeric(rownames(acomp.hl.w.norm))%in%as.numeric(rownames(age.hl.ss[age.hl.ss$Total>30,])),]
hl.age.acomp.norm2=hl.age.acomp.norm[as.numeric(rownames(hl.age.acomp.norm))%in%as.numeric(rownames(age.hl.ss[age.hl.ss$Total>30,])),]
dim(age.hl.acomp.norm2)
dim(hl.age.acomp.norm2)
dim(acomp.hl.w.norm2)
table7=xtable(acomp.hl.w.norm2,digits=4)
print(table7,type="html")
age.dv$tmp=1
age.dv.ss=xtabs(tmp~year+state,data=age.dv)
age.dv.ss=as.data.frame.matrix(age.dv.ss)
age.dv.ss$GaFL=age.dv.ss[,2]+age.dv.ss[,3]
age.dv.ss=age.dv.ss[,c(-1,-2,-3)]
age.dv.ss$Total=rowSums(age.dv.ss)
table6=xtable(age.dv.ss,digits=0)
print(table6,type="html")
#truncate to years with minimun sample size
cull.dv.ages=30
dv.ss.trim=as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,]))
dv.norm.a.unw.trim2=dv.norm.a.unw.trim[as.numeric(rownames(dv.norm.a.unw.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dv.acomp.norm.w.trim2=dv.acomp.norm.w.trim[as.numeric(rownames(dv.acomp.norm.w.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dv.norm.a.unw.trim2=rbind(dv.ss.trim,dv.norm.a.unw.trim2)
age.dv.ss$Total
age.dv.ss
age.dv$tmp=1
age.dv.ss=xtabs(tmp~year+state,data=age.dv)
age.dv.ss=as.data.frame.matrix(age.dv.ss)
age.dv.ss$GaFL=age.dv.ss[,2]+age.dv.ss[,3]
age.dv.ss=age.dv.ss[,c(-1,-2,-3)]
age.dv.ss$Total=rowSums(age.dv.ss)
table6=xtable(age.dv.ss,digits=0)
age.dv$tmp=1
age.dv.ss=xtabs(tmp~year+state,data=age.dv)
age.dv.ss=as.data.frame.matrix(age.dv.ss)
age.dv.ss
age.dv.ss=age.dv.ss[,c(2,3,1)]
age.dv.ss
age.dv.ss$Total=rowSums(age.dv.ss)
table6=xtable(age.dv.ss,digits=0)
print(table6,type="html")
dv.ss.trim=as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,]))
dv.norm.a.unw.trim2=dv.norm.a.unw.trim[as.numeric(rownames(dv.norm.a.unw.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dv.acomp.norm.w.trim2=dv.acomp.norm.w.trim[as.numeric(rownames(dv.acomp.norm.w.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dv.norm.a.unw.trim2=rbind(dv.ss.trim,dv.norm.a.unw.trim2)
dv.ss.trim=as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,]))
dv.norm.a.unw.trim2=dv.norm.a.unw.trim[as.numeric(rownames(dv.norm.a.unw.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dv.acomp.norm.w.trim2=dv.acomp.norm.w.trim[as.numeric(rownames(dv.acomp.norm.w.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dim(dv.norm.a.unw.trim2)
length(dv.ss.trim)
dv.ss.trim
dv.norm.a.unw.trim2=cbind(dv.ss.trim,dv.norm.a.unw.trim2)
dv.norm.a.unw.trim2
age.dv.ss
dv.ss.trim=rownames(age.dv.ss[as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])))
dv.ss.trim=age.dv.ss$Total[as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,]))
)
dv.ss.trim
dv.ss.trim=age.dv.ss$Total[age.dv.ss$Total>30]
dv.ss.trim
cull.dv.ages=30
dv.ss.trim=age.dv.ss$Total[age.dv.ss$Total>30]
dv.norm.a.unw.trim2=dv.norm.a.unw.trim[as.numeric(rownames(dv.norm.a.unw.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dv.acomp.norm.w.trim2=dv.acomp.norm.w.trim[as.numeric(rownames(dv.acomp.norm.w.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dv.norm.a.unw.trim2=cbind(dv.ss.trim,dv.norm.a.unw.trim2)
dv.norm.a.unw.trim2
cull.dv.ages=30
dv.age.n=age.dv.ss$Total[age.dv.ss$Total>30]
dv.norm.a.unw.trim2=dv.norm.a.unw.trim[as.numeric(rownames(dv.norm.a.unw.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dv.acomp.norm.w.trim2=dv.acomp.norm.w.trim[as.numeric(rownames(dv.acomp.norm.w.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>30,])),]
dv.norm.a.unw.trim2=cbind(dv.age.n,dv.norm.a.unw.trim2)
dv.norm.a.unw.trim2
dv.acomp.norm.w.trim2
cull.hl.ages=30
hl.age.n=age.hl.ss$Total[age.hl.ss$Total>cull.hl.ages]
acomp.hl.w.norm2=acomp.hl.w.norm[as.numeric(rownames(acomp.hl.w.norm))%in%as.numeric(rownames(age.hl.ss[age.hl.ss$Total>cull.hl.ages,])),]
hl.age.acomp.norm2=hl.age.acomp.norm[as.numeric(rownames(hl.age.acomp.norm))%in%as.numeric(rownames(age.hl.ss[age.hl.ss$Total>cull.hl.ages,])),]
acomp.hl.w.norm3=cbind(hl.age.n,acomp.hl.w.norm2)
acomp.hl.w.norm3
windows(record=TRUE,width=7,height=10)
par(mar=c(1.5, 2, 1, 1) + 0.1,oma=c(4,4,0,0))
agebins=as.numeric(colnames(acomp.hl.w.norm2))
year=as.numeric(rownames(acomp.hl.w.norm2))
for(i in 1:dim(dv.acomp.norm.w.trim2)[1]){
plot(agebins,dv.acomp.norm.w.trim2[i,],type='n',ylim=c(0,max(dv.acomp.norm.w.trim2)),ylab='',xlab='Age')
text(5,.5,paste(year[i],'Handline',sep='-'),cex=1.2)
lines(agebins,dv.acomp.norm.w.trim2[i,],lwd=2,lty=3,col='darkorange')
lines(agebins,dv.acomp.norm.w.trim2[i,],lwd=2,lty=1,col='blue')
legend('topright',lty=c(3,1),lwd=c(2,2),col=c('darkorange','blue'),legend=c('unweighted','weighted'),cex=1.2,bty='n')
}
windows(record=TRUE,width=7,height=10)
par(mar=c(1.5, 2, 1, 1) + 0.1,oma=c(4,4,0,0))
agebins=as.numeric(colnames(dv.acomp.norm.w.trim2))
year=as.numeric(rownames(dv.acomp.norm.w.trim2))
for(i in 1:dim(dv.acomp.norm.w.trim2)[1]){
plot(agebins,dv.acomp.norm.w.trim2[i,],type='n',ylim=c(0,max(dv.acomp.norm.w.trim2)),ylab='',xlab='Age')
text(5,.5,paste(year[i],'Handline',sep='-'),cex=1.2)
lines(agebins,dv.acomp.norm.w.trim2[i,],lwd=2,lty=3,col='darkorange')
lines(agebins,dv.acomp.norm.w.trim2[i,],lwd=2,lty=1,col='blue')
legend('topright',lty=c(3,1),lwd=c(2,2),col=c('darkorange','blue'),legend=c('unweighted','weighted'),cex=1.2,bty='n')
}
gafl.dv.a.w
gafl.dv.a.w=dv.norm.a.unw.trim[as.numeric(rownames(dv.norm.a.unw.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>cull.dv.ages,])),]
#trim state-specific comps to match final
gafl.dv.a.w.trim=gafl.dv.a.w[as.numeric(rownames(gafl.dv.a.w))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>cull.dv.ages,])),]
gafl.dv.a.w.trim
#trim state-specific comps to match final
nc.dv.a.w.trim=nc.dv.a.w[as.numeric(rownames(nc.dv.a.w))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>cull.dv.ages,])),]
sc.dv.a.w.trim=sc.dv.a.w[as.numeric(rownames(sc.dv.a.w))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>cull.dv.ages,])),]
gafl.dv.a.w.trim=gafl.dv.a.w[as.numeric(rownames(gafl.dv.a.w))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>cull.dv.ages,])),]
windows(record=TRUE,width=7,height=10)
par(mar=c(1.5, 2, 1, 1) + 0.1,oma=c(4,4,0,0))
agebins=as.numeric(colnames(dv.acomp.norm.w.trim2))
year=as.numeric(rownames(dv.acomp.norm.w.trim2))
for(i in 1:dim(dv.acomp.norm.w.trim2)[1]){
plot(agebins,dv.acomp.norm.w.trim2[i,],type='n',ylim=c(0,max(dv.acomp.norm.w.trim2)),ylab='',xlab='Age')
text(5,.5,paste(year[i],'Diving',sep='-'),cex=1.2)
lines(agebins,dv.norm.a.unw.trim2[i,],lwd=2,lty=3)
lines(agebins,dv.acomp.norm.w.trim2[i,],lwd=2,lty=1)
lines(agebins,nc.dv.a.w.trim[i,],lty=3,lwd=2,col="green")
lines(agebins,sc.dv.a.w.trim[i,],lty=3,lwd=2,col="blue")
lines(agebins,gafl.dv.a.w.trim[i,],lty=3,lwd=2,col="orange")
#lines(agebins,fl.dv.w.trim[i,],lty=3,lwd=2,col="red")
legend('topright',lty=c(1,3,3,3,3),lwd=c(2,2,2,2,2),col=c('black','black','green','blue','orange'),legend=c('weighted','unweighted','NC','SC','GAFL'))
legend('topright',lty=c(3,1),lwd=c(2,2),col=c('darkorange','blue'),legend=c('unweighted','weighted'),cex=1.2,bty='n')
}
agebins
plot(agebins,dv.acomp.norm.w.trim2[1,],type='n',ylim=c(0,max(dv.acomp.norm.w.trim2)),ylab='',xlab='Age')
text(5,.5,paste(year[1],'Diving',sep='-'),cex=1.2)
lines(agebins,dv.norm.a.unw.trim2[1,],lwd=2,lty=3)
dv.norm.a.unw.trim2
cull.dv.ages=30
dv.age.n=age.dv.ss$Total[age.dv.ss$Total>cull.dv.ages]
dv.norm.a.unw.trim2=dv.norm.a.unw.trim[as.numeric(rownames(dv.norm.a.unw.trim))%in%as.numeric(rownames(age.dv.ss[age.dv.ss$Total>cull.dv.ages,])),]
dv.norm.a.unw.trim2
windows(record=TRUE,width=7,height=10)
par(mar=c(1.5, 2, 1, 1) + 0.1,oma=c(4,4,0,0))
agebins=as.numeric(colnames(dv.acomp.norm.w.trim2))
year=as.numeric(rownames(dv.acomp.norm.w.trim2))
for(i in 1:dim(dv.acomp.norm.w.trim2)[1]){
plot(agebins,dv.acomp.norm.w.trim2[i,],type='n',ylim=c(0,max(dv.acomp.norm.w.trim2)),ylab='',xlab='Age')
text(5,.5,paste(year[i],'Diving',sep='-'),cex=1.2)
lines(agebins,dv.norm.a.unw.trim2[i,],lwd=2,lty=3)
lines(agebins,dv.acomp.norm.w.trim2[i,],lwd=2,lty=1)
lines(agebins,nc.dv.a.w.trim[i,],lty=3,lwd=2,col="green")
lines(agebins,sc.dv.a.w.trim[i,],lty=3,lwd=2,col="blue")
lines(agebins,gafl.dv.a.w.trim[i,],lty=3,lwd=2,col="orange")
legend('topright',lty=c(1,3,3,3,3),lwd=c(2,2,2,2,2),col=c('black','black','green','blue','orange'),legend=c('weighted','unweighted','NC','SC','GAFL'))
legend('topright',lty=c(3,1),lwd=c(2,2),col=c('darkorange','blue'),legend=c('unweighted','weighted'),cex=1.2,bty='n')
}
dim(nc.hl.w)
dim(sc.hl.w)
dim(gafl.hl.w)
dim(nc.dv.w)
dim(sc.dv.w)
dim(gafl.dv.w)
**Figure 3.**  Commercial handline weighted Age composition.  (1979-1982 unweighted due to lack of length data, years with greater than 46 fish)
